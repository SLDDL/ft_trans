<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OAuth Test Frontend</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .container {
            background: white;
            padding: 2rem;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            text-align: center;
            max-width: 500px;
            width: 90%;
        }
        
        h1 {
            color: #333;
            margin-bottom: 2rem;
            font-size: 2rem;
        }
        
        .auth-buttons {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .oauth-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            padding: 15px 20px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            text-decoration: none;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .oauth-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }
        
        .discord-btn {
            background-color: #5865f2;
            color: white;
        }
        
        .github-btn {
            background-color: #333;
            color: white;
        }
        
        .user-info {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            display: none;
        }
        
        .user-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            margin-bottom: 1rem;
        }
        
        .logout-btn {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .logout-btn:hover {
            background-color: #c82333;
        }
        
        .error-message {
            background-color: #f8d7da;
            color: #721c24;
            padding: 1rem;
            border-radius: 5px;
            margin-bottom: 1rem;
            display: none;
        }
        
        .success-message {
            background-color: #d4edda;
            color: #155724;
            padding: 1rem;
            border-radius: 5px;
            margin-bottom: 1rem;
            display: none;
        }
        
        .loading {
            display: none;
            margin: 1rem 0;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .token-display {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            word-break: break-all;
            margin-top: 1rem;
            max-height: 100px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>OAuth Test Frontend</h1>
        
        <div class="error-message" id="errorMessage"></div>
        <div class="success-message" id="successMessage"></div>
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Processing authentication...</p>
        </div>
        
        <div class="auth-section" id="authSection">
            <p style="margin-bottom: 2rem; color: #666;">
                Test OAuth integration with Discord and GitHub
            </p>
            
            <div class="auth-buttons">
                <a href="http://localhost:3000/oauth/discord" class="oauth-btn discord-btn">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M20.317 4.3698a19.7913 19.7913 0 00-4.8851-1.5152.0741.0741 0 00-.0785.0371c-.211.3753-.4447.8648-.6083 1.2495-1.8447-.2762-3.68-.2762-5.4868 0-.1636-.3933-.4058-.8742-.6177-1.2495a.077.077 0 00-.0785-.037 19.7363 19.7363 0 00-4.8852 1.515.0699.0699 0 00-.0321.0277C.5334 9.0458-.319 13.5799.0992 18.0578a.0824.0824 0 00.0312.0561c2.0528 1.5076 4.0413 2.4228 5.9929 3.0294a.0777.0777 0 00.0842-.0276c.4616-.6304.8731-1.2952 1.226-1.9942a.076.076 0 00-.0416-.1057c-.6528-.2476-1.2743-.5495-1.8722-.8923a.077.077 0 01-.0076-.1277c.1258-.0943.2517-.1923.3718-.2914a.0743.0743 0 01.0776-.0105c3.9278 1.7933 8.18 1.7933 12.0614 0a.0739.0739 0 01.0785.0095c.1202.099.246.1981.3728.2924a.077.077 0 01-.0066.1276 12.2986 12.2986 0 01-1.873.8914.0766.0766 0 00-.0407.1067c.3604.698.7719 1.3628 1.225 1.9932a.076.076 0 00.0842.0286c1.961-.6067 3.9495-1.5219 6.0023-3.0294a.077.077 0 00.0313-.0552c.5004-5.177-.8382-9.6739-3.5485-13.6604a.061.061 0 00-.0312-.0286zM8.02 15.3312c-1.1825 0-2.1569-1.0857-2.1569-2.419 0-1.3332.9555-2.4189 2.157-2.4189 1.2108 0 2.1757 1.0952 2.1568 2.419-.0189 1.3332-.9555 2.4189-2.1569 2.4189zm7.9748 0c-1.1825 0-2.1569-1.0857-2.1569-2.419 0-1.3332.9554-2.4189 2.1569-2.4189 1.2108 0 2.1757 1.0952 2.1568 2.419 0 1.3332-.946 2.4189-2.1568 2.4189Z"/>
                    </svg>
                    Login with Discord
                </a>
                
                <a href="http://localhost:3000/oauth/github" class="oauth-btn github-btn">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
                    </svg>
                    Login with GitHub
                </a>
            </div>
        </div>
        
        <div class="user-info" id="userInfo">
            <img id="userAvatar" class="user-avatar" src="" alt="User Avatar">
            <h3 id="userName"></h3>
            <p id="userEmail"></p>
            <p><strong>Provider:</strong> <span id="userProvider"></span></p>
            <button class="logout-btn" onclick="logout()">Logout</button>
            
            <div class="token-display" id="tokenDisplay"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3000';
        
        // Check for authentication result on page load
        window.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('token');
            const error = urlParams.get('error');
            
            if (token) {
                handleAuthSuccess(token);
            } else if (error) {
                handleAuthError(error);
            } else {
                // Check if we have a stored token
                const storedToken = localStorage.getItem('authToken');
                if (storedToken) {
                    verifyToken(storedToken);
                }
            }
            
            // Clean URL
            if (token || error) {
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        });
        
        function handleAuthSuccess(token) {
            localStorage.setItem('authToken', token);
            showSuccess('Authentication successful!');
            setTimeout(() => {
                fetchUserInfo(token);
            }, 1000);
        }
        
        function handleAuthError(error) {
            let message = 'Authentication failed';
            switch(error) {
                case 'invalid_state':
                    message = 'Invalid state parameter. Please try again.';
                    break;
                case 'oauth_failed':
                    message = 'OAuth authentication failed. Please try again.';
                    break;
                case 'access_denied':
                    message = 'Access denied by user.';
                    break;
                default:
                    message = `Authentication error: ${error}`;
            }
            showError(message);
        }
        
        async function verifyToken(token) {
            try {
                const response = await fetch(`${API_BASE}/validate`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    fetchUserInfo(token);
                } else {
                    localStorage.removeItem('authToken');
                    showError('Session expired. Please login again.');
                }
            } catch (error) {
                console.error('Token verification failed:', error);
                localStorage.removeItem('authToken');
                showError('Failed to verify session.');
            }
        }
        
        async function fetchUserInfo(token) {
            showLoading(true);
            
            try {
                const response = await fetch(`${API_BASE}/me`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    displayUserInfo(data.user, token);
                } else {
                    throw new Error('Failed to fetch user info');
                }
            } catch (error) {
                console.error('Failed to fetch user info:', error);
                showError('Failed to load user information.');
                localStorage.removeItem('authToken');
            } finally {
                showLoading(false);
            }
        }
        
        function displayUserInfo(user, token) {
            document.getElementById('userName').textContent = user.username || 'N/A';
            document.getElementById('userEmail').textContent = user.email || 'N/A';
            document.getElementById('userProvider').textContent = user.provider || 'N/A';
            
            const avatar = document.getElementById('userAvatar');
            if (user.avatar) {
                avatar.src = user.avatar;
                avatar.style.display = 'block';
            } else {
                avatar.style.display = 'none';
            }
            
            // Show token (first 50 chars)
            document.getElementById('tokenDisplay').textContent = `Token: ${token.substring(0, 50)}...`;
            
            document.getElementById('authSection').style.display = 'none';
            document.getElementById('userInfo').style.display = 'block';
            
            hideMessages();
        }
        
        async function logout() {
            const token = localStorage.getItem('authToken');
            
            if (token) {
                try {
                    await fetch(`${API_BASE}/logout`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                } catch (error) {
                    console.error('Logout request failed:', error);
                }
            }
            
            localStorage.removeItem('authToken');
            
            document.getElementById('authSection').style.display = 'block';
            document.getElementById('userInfo').style.display = 'none';
            
            showSuccess('Logged out successfully!');
            setTimeout(hideMessages, 3000);
        }
        
        function showError(message) {
            const errorEl = document.getElementById('errorMessage');
            errorEl.textContent = message;
            errorEl.style.display = 'block';
            document.getElementById('successMessage').style.display = 'none';
        }
        
        function showSuccess(message) {
            const successEl = document.getElementById('successMessage');
            successEl.textContent = message;
            successEl.style.display = 'block';
            document.getElementById('errorMessage').style.display = 'none';
        }
        
        function hideMessages() {
            document.getElementById('errorMessage').style.display = 'none';
            document.getElementById('successMessage').style.display = 'none';
        }
        
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }
    </script>
</body>
</html>